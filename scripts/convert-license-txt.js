const fs = require('fs');
const path = require('path');

const jsonPath = path.resolve(process.cwd(), 'license-report.json');
const outPath = path.resolve(process.cwd(), 'license-report.txt');

if (!fs.existsSync(jsonPath)) {
  console.error('license-report.json not found. Run license-checker JSON output first.');
  process.exitCode = 2;
  return;
}

const raw = fs.readFileSync(jsonPath, 'utf8');
let data;
try {
  data = JSON.parse(raw);
} catch (err) {
  console.error('Failed to parse JSON:', err.message);
  process.exitCode = 2;
  return;
}

const lines = [];
lines.push('License report generated by license-checker');
lines.push('');
Object.keys(data).sort().forEach((key) => {
  const entry = data[key];
  const license = entry.licenses || entry.license || '';
  const repo = entry.repository || entry.url || '';
  lines.push(`Module: ${key}`);
  lines.push(`License: ${license}`);
  lines.push(`Repository: ${repo}`);
  lines.push('');
});

fs.writeFileSync(outPath, lines.join('\n'), 'utf8');
console.log('Wrote', outPath);
